openapi: 3.1.0
info:
  title: Rust/serde Discriminator API
  version: 1.0.0
  description: Tests the Rust/serde pattern where oneOf items are allOf with $ref + discriminator object
paths: {}
components:
  schemas:
    MessagePartDto:
      oneOf:
        - allOf:
            - $ref: '#/components/schemas/TextPartDto'
              description: Text content
            - type: object
              required:
                - type
              properties:
                type:
                  type: string
                  enum:
                    - Text
          description: Text content
        - allOf:
            - $ref: '#/components/schemas/ReasoningPartDto'
              description: Reasoning/thinking content
            - type: object
              required:
                - type
              properties:
                type:
                  type: string
                  enum:
                    - Reasoning
          description: Reasoning/thinking content
        - allOf:
            - $ref: '#/components/schemas/ToolPartDto'
              description: Tool call with state machine
            - type: object
              required:
                - type
              properties:
                type:
                  type: string
                  enum:
                    - Tool
          description: Tool call with state machine
      description: A content part of a message.
    TextPartDto:
      type: object
      properties:
        content:
          type: string
          description: The text content
      required:
        - content
    ReasoningPartDto:
      type: object
      properties:
        reasoning:
          type: string
          description: The reasoning content
      required:
        - reasoning
    ToolPartDto:
      type: object
      properties:
        toolName:
          type: string
          description: The name of the tool
        toolArgs:
          type: object
          description: The arguments for the tool
      required:
        - toolName
    Message:
      type: object
      properties:
        parts:
          type: array
          items:
            $ref: '#/components/schemas/MessagePartDto'
      required:
        - parts

    # Test for allOf with flattening and nullable oneOf patterns
    SessionEventDto:
      oneOf:
        - type: object
          description: Sent when SSE connection is established.
          required:
            - event
          properties:
            event:
              type: string
              enum:
                - Connected
        - allOf:
            - $ref: '#/components/schemas/SessionStateDto'
              description: Session state delta.
            - oneOf:
                - type: 'null'
                - $ref: '#/components/schemas/MessageDto'
            - type: object
              description: Session state was updated.
              required:
                - event
              properties:
                event:
                  type: string
                  enum:
                    - SessionUpdated
          description: Session state was updated (delta - only changed fields present).
        - type: object
          description: Session was deleted.
          required:
            - session_id
            - event
          properties:
            event:
              type: string
              enum:
                - SessionDeleted
            session_id:
              type: integer
              format: int64
              description: ID of deleted session.
      description: Server-sent event for a session

    SessionStateDto:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Session ID
        name:
          type: string
          description: Session name
      required:
        - id

    MessageDto:
      type: object
      properties:
        content:
          type: string
          description: Message content
        role:
          type: string
          description: Message role
      required:
        - content
        - role
